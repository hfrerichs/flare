#!/usr/bin/env python
import argparse
import os
from subprocess import call
import sys

import flare.pyplot as fplt

def set_default_subparser(self, name, args=None):
    """default subparser selection:
    name: is the name of the subparser to call by default
    args: if set is the argument list handed to parse_args()
    """
    subparser_found = False
    for arg in sys.argv[1:]:
        if arg in ['-h', '--help']:
            break
    else:
        for x in self._subparsers._actions:
            if not isinstance(x, argparse._SubParsersAction):
                continue
            for sp_name in x._name_parser_map.keys():
                if sp_name in sys.argv[1:]:
                    subparser_found = True
        if not subparser_found:
            if args is None:
                sys.argv.insert(1, name)
            else:
                args.insert(0, name)

argparse.ArgumentParser.set_default_subparser = set_default_subparser

# 1. run FLARE backend
def run(args):
    THIS  = os.path.dirname(__file__)
    flare = os.path.join(THIS, "FLARE")
    cmd   = [flare, args.cmd, args.control_file]
    if args.debug: args.Debugger = 'gdb'
    if args.Debugger: [cmd.insert(0, x) for x in ['--args', args.Debugger]]
    call(cmd)


# 2. connection length and other data plots
def plot(args):
    fplt.plot_lc(args.geometry_file, args.data_file, qplot=args.qplot)


def main():
    # create main parser
    parser      = argparse.ArgumentParser()
    subparsers  = parser.add_subparsers(title='subcommands', dest='cmd')

    # 1. create parser for FLARE backend
    parser_run  = subparsers.add_parser("run", help="run FLARE backend")
    parser_run.add_argument("-c", "--control_file", default="run.conf", help="set run control file (default: run.conf)")
    debug_run   = parser_run.add_mutually_exclusive_group()
    debug_run.add_argument("-d", "--debug", action='store_true', help="run FLARE through default debugger (gdb)")
    debug_run.add_argument("-D", "--Debugger", help="run FLARE through selected debugger")
    parser_run.set_defaults(func=run)

    # 2. create parser for connection length and other data plots
    parser_plot = subparsers.add_parser("plot", help="plot connection length and other data")
    parser_plot.add_argument("qplot", choices=['lc', 'lcs', 'lc_bwd', 'lc_fwd'], help="data quantity")
    parser_plot.add_argument("-g", "--geometry_file", default="grid.dat")
    parser_plot.add_argument("-d", "--data_file", default="output.txt")
    parser_plot.set_defaults(func=plot)

    # parse the args and call whatever subcommand was selected
    parser.set_default_subparser("run")
    args = parser.parse_args()
    args.func(args)


if __name__ == "__main__":
    main()
